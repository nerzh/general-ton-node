# Инструкция по установке полной ноды сети ton-rocks
Проверялась на Ubuntu 18.04

1. Скачиваем репозиторий
```git clone https://github.com/ton-rocks/general-ton-node.git```

2. Переходим в папку scripts
```cd ./general-node/scripts```

Обратите внимание, далее все команды выполняются из папки scripts!

3. Устанавливаем зависимости (только ubuntu, можно установить необходимые пакеты руками)
```./system_init.sh```

Возможно, для запуска докера понадобится создать группу и добавить туда текущего пользователя

```bash
newgrp docker
sudo usermod -a -G docker текущий_пользователь
```

Так же желательно установить chrony (пример https://www.tecmint.com/install-chrony-in-centos-ubuntu-linux/)

4. Собираем докер контейнер (будет собрана нода TON, нужно RAM не менее 4GB)
```./docker_build.sh```

5. Открываем файл env.sh в любом текстовом редакторе. При необходимости меняем IP и порты.

6. Открываем указанные порты в файрволе. Для ubuntu команды будут выглядеть так:
```sudo ufw allow порт```

Открыть порты нужно для следующих сервисов, упомянутых в env.sh 
```
DHT_PORT
ADNL_PORT
LITE_PORT
JSON_EXPLORER_PORT
BLOCK_EXPLORER_PORT
```

7. Первый запуск ноды
```
./docker_create_storage.sh
./docker_run.sh
```
Ждём несколько минут, при первом запуске сгенерируются ключи кошелька валидатора, а так же некоторые конфиги

8. Экспортируем сгенерированные файлы из контейнера
```./docker_export_wallet.sh```

Экспортируются следующие файлы:
адрес и ключи кошелька валидатора
```
validator.hexaddr
validator.addr
validator.pk
```

Сохраните их в доступном месте, при следующем запуске ./docker_export_wallet.sh они перепишутся!

9. Экспортируем конфигурацию

```./docker_export_conf.sh```

Конфигурации DHT и lite-server
```
dht_node.conf
liteserver.conf
```

Ключи для доступа к lite-server и консоли ноды
```
liteserver.pub
console_server.pub
console_client
```

Если скрипты говорят, что некоторых файлов нет, ждём ещё и перезапускаем

10. Отправляем запрос на тестовые монеты. В запросе указываем следующую информацию:
- адрес кошелька валидатора, из файла validator.hexaddr
- содержимое файлов dht_node.conf и liteserver.conf
- порты JSON_EXPLORER_PORT и BLOCK_EXPLORER_PORT (не нужно, если файл env.sh не меняли)

11. Дожидаемся синхронизации ноды командой
```./docker_status.sh```
Разница между последними 2 цифрами должна быть в пределах 20
stateserializermasterchainseqno                 589364
shardclientmasterchainseqno                     589218

12. Дожидаемся зачисления монет на кошелёк. Состояние кошелька можно проверить командой
```./docker_wallet_status.sh```
```Account state is EMPTY with balance 0``` говорит о том, что монет в аккаунте нет
```Account state is UNINIT with balance 100000000000000ng``` говорит о том, на кошельке 100000 монет, но код кошелька не задеплоен

Состояние кошелька так же можно посмотреть в блокчейн эксплорере, который доступен у вас по BLOCK_EXPLORER_PORT порту

Когда появится ненулевой баланс, кошелёк нужно задеплоить командой
```./docker_wallet_deploy.sh```

после чего состояние должно измениться на
```Account state is ACTIVE with balance 99999956409603ng```

12. Когда нода синхронизировалась, нужно установить в cron запуск скриптов участия в выборах
Выполняем ```crontab -e```
и вставляем строку

```*/10 * * * *     cd путь_к_папке_scripts && ./docker_participate.sh```

13. Командой 
```./docker_logs.sh```
можно получить логи регистрации в выборах (participate.log и reap.log)


# Если возникают проблемы

1. Получить лог ноды TON можно командой
```./docker_node_logs.sh```
(осторожно, он большой!)
Логи остальных сервисов и скриптов
```./docker_logs.sh```
2. Состояние файрвола командой
```sudo ufw status```
3. Открытые порты
```sudo netstat -ntlp | grep LISTEN```
4. Нагрузку на сервер
```htop```
5. Нагрузку на диски 
```iostat -dx -N 2```
6. Скорость сети
```https://www.speedtest.net/ru/apps/cli```
7. Состояние сети
```sudo iftop -i lo -P```


# Если сменился IP

1. Останавливаем запущенный контейнер
```./docker_stop.sh```

2. Меняем PUBLIC_IP в файле env.sh

2. Запускаем снова
```./docker_start.sh```

3. Выполняем команду
```./docker_export_conf.sh```

4. Отсылаем файлы dht_node.conf и liteserver.conf


# Перенос ноды на другой сервер

1. Дожидаемся, когда выборы закончатся. Проверить можно в логе participate.log
Фраза "No active election, exiting" означает, что выборы закончены

2. Убираем запуск скрипта из крона. 
Запускаем ```crontab -e``` и удаляем строку
```*/10 * * * *     cd путь_к_папке_scripts && ./docker_participate.sh```

3. На новом сервере выполняем шаги 1-7 основной инструкции

4. Копируем файлы 
```
validator.hexaddr
validator.addr
validator.pk
```
в папку scripts

5. Запускаем команду импорта ключей
```./docker_import.sh```

6. Выполняем шаги 9-13 основной инструкции


# Запускаем несколько нод на 1 сервере:

Проще всего сделать несколько копий папки scripts и поменять в каждой env.sh
Затем выполнить все действия из инструкции в каждой папке
